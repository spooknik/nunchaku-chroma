name: Build and Release Wheels

on:
  workflow_dispatch:
    inputs:
      nunchaku_version:
        description: 'Nunchaku version to repackage (leave empty for latest)'
        required: false
        default: ''
      create_release:
        description: 'Create GitHub release'
        required: false
        default: 'true'
        type: boolean

jobs:
  build-wheels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Build all wheels
        run: |
          if [ -n "${{ github.event.inputs.nunchaku_version }}" ]; then
            python build_wheels.py --version "${{ github.event.inputs.nunchaku_version }}"
          else
            python build_wheels.py
          fi

      - name: List built wheels
        run: ls -la dist/

      - name: Upload wheels as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels
          path: dist/*.whl

      - name: Upload version manifest
        uses: actions/upload-artifact@v4
        with:
          name: manifest
          path: dist/nunchaku_chroma_versions.json

  create-release:
    needs: build-wheels
    runs-on: ubuntu-latest
    if: github.event.inputs.create_release == 'true'
    permissions:
      contents: write
    steps:
      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          name: wheels
          path: dist/

      - name: Download manifest
        uses: actions/download-artifact@v4
        with:
          name: manifest
          path: dist/

      - name: Get version from manifest
        id: version
        run: |
          VERSION=$(python3 -c "import json; print(json.load(open('dist/nunchaku_chroma_versions.json'))['versions'][0])")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: nunchaku-chroma ${{ steps.version.outputs.version }}
          body: |
            ## nunchaku-chroma ${{ steps.version.outputs.version }}

            Repackaged nunchaku with Chroma model support.

            ### Installation

            Download the wheel for your platform/Python/PyTorch version:

            ```bash
            pip install nunchaku_chroma-${{ steps.version.outputs.version }}+torchX.X-cpXXX-cpXXX-platform.whl
            ```

            Or install directly from URL:

            ```bash
            # Example for Python 3.12, PyTorch 2.7, Linux
            pip install https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/nunchaku_chroma-${{ steps.version.outputs.version }}+torch2.7-cp312-cp312-linux_x86_64.whl
            ```

            ### Supported Configurations

            - **Platforms**: Linux x86_64, Windows AMD64
            - **Python**: 3.10, 3.11, 3.12, 3.13
            - **PyTorch**: 2.7, 2.8, 2.9, 2.10

            ### Usage

            ```python
            from nunchaku import NunchakuChromaTransformer2DModel

            transformer = NunchakuChromaTransformer2DModel.from_pretrained(
                "path/to/quantized/chroma/model.safetensors"
            )
            ```
          files: |
            dist/*.whl
            dist/nunchaku_chroma_versions.json
          draft: false
          prerelease: false
